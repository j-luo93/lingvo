

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>lingvo.core.rnn_cell_test &mdash; lingvo  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> lingvo
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../lingvo.html">lingvo package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">lingvo</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>lingvo.core.rnn_cell_test</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for lingvo.core.rnn_cell_test</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2018 The TensorFlow Authors. All Rights Reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="sd">&quot;&quot;&quot;Tests for rnn_cell.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

<span class="kn">from</span> <span class="nn">tensorflow.contrib.cudnn_rnn.python.ops</span> <span class="k">import</span> <span class="n">cudnn_rnn_ops</span>
<span class="kn">from</span> <span class="nn">tensorflow.python.ops</span> <span class="k">import</span> <span class="n">gen_cudnn_rnn_ops</span>

<span class="kn">from</span> <span class="nn">lingvo.core</span> <span class="k">import</span> <span class="n">cudnn_rnn_utils</span>
<span class="kn">from</span> <span class="nn">lingvo.core</span> <span class="k">import</span> <span class="n">py_utils</span>
<span class="kn">from</span> <span class="nn">lingvo.core</span> <span class="k">import</span> <span class="n">quant_utils</span>
<span class="kn">from</span> <span class="nn">lingvo.core</span> <span class="k">import</span> <span class="n">rnn_cell</span>

<span class="n">UNI_RNN</span> <span class="o">=</span> <span class="n">cudnn_rnn_ops</span><span class="o">.</span><span class="n">CUDNN_RNN_UNIDIRECTION</span>
<span class="n">BI_RNN</span> <span class="o">=</span> <span class="n">cudnn_rnn_ops</span><span class="o">.</span><span class="n">CUDNN_RNN_BIDIRECTION</span>

<span class="n">_INIT_RANDOM_SEED</span> <span class="o">=</span> <span class="mi">429891685</span>
<span class="n">_NUMPY_RANDOM_SEED</span> <span class="o">=</span> <span class="mi">12345</span>
<span class="n">_RANDOM_SEED</span> <span class="o">=</span> <span class="mi">98274</span>


<div class="viewcode-block" id="RNNCellTest"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest">[docs]</a><span class="k">class</span> <span class="nc">RNNCellTest</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">_testLSTMSimpleHelper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">inline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">couple_input_forget_gates</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">apply_pruning</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">(</span>
        <span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">py_utils</span><span class="o">.</span><span class="n">SessionConfig</span><span class="p">(</span><span class="n">inline</span><span class="o">=</span><span class="n">inline</span><span class="p">)):</span>
      <span class="n">params</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LSTMCellSimple</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
      <span class="n">params</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lstm&#39;</span>
      <span class="n">params</span><span class="o">.</span><span class="n">output_nonlinearity</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="n">params</span><span class="o">.</span><span class="n">params_init</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">WeightInit</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1.24</span><span class="p">,</span> <span class="n">_INIT_RANDOM_SEED</span><span class="p">)</span>

      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">global_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">per_step_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_input_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_output_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">couple_input_forget_gates</span> <span class="o">=</span> <span class="n">couple_input_forget_gates</span>

      <span class="n">lstm</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LSTMCellSimple</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;lstm vars = &#39;</span><span class="p">,</span> <span class="n">lstm</span><span class="o">.</span><span class="n">vars</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;wm&#39;</span> <span class="ow">in</span> <span class="n">lstm</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;b&#39;</span> <span class="ow">in</span> <span class="n">lstm</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

      <span class="n">num_param_vectors</span> <span class="o">=</span> <span class="mi">6</span> <span class="k">if</span> <span class="n">couple_input_forget_gates</span> <span class="k">else</span> <span class="mi">8</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">lstm</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span>
                       <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_param_vectors</span><span class="p">]))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">lstm</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span>
                       <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="n">num_param_vectors</span><span class="p">]))</span>

      <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">_NUMPY_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">inputs</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">act</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)],</span>
          <span class="n">padding</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
      <span class="n">state0</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">c</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
          <span class="n">m</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

      <span class="n">state1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">FPropDefaultTheta</span><span class="p">(</span><span class="n">state0</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>

      <span class="c1"># Initialize all the variables, and then run one step.</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

      <span class="n">variable_count</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">wts</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="s1">&#39;LSTMCellSimple_vars&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">variable_count</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">wts</span><span class="p">))</span>

      <span class="c1"># pyformat: disable</span>
      <span class="k">if</span> <span class="n">couple_input_forget_gates</span><span class="p">:</span>
        <span class="n">m_expected</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="mf">0.22088</span><span class="p">,</span> <span class="mf">0.244225</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">0.123647</span><span class="p">,</span> <span class="mf">0.25378</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">0.163328</span><span class="p">,</span> <span class="mf">0.214796</span><span class="p">]]</span>
        <span class="n">c_expected</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="mf">0.355682</span><span class="p">,</span> <span class="mf">0.711696</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">0.313728</span><span class="p">,</span> <span class="mf">0.633475</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">0.485248</span><span class="p">,</span> <span class="mf">0.961122</span><span class="p">]]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">m_expected</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="mf">0.095727</span><span class="p">,</span> <span class="mf">0.476658</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">0.04662</span><span class="p">,</span> <span class="mf">0.180589</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">0.001656</span><span class="p">,</span> <span class="mf">0.374141</span><span class="p">]]</span>
        <span class="n">c_expected</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="mf">0.241993</span><span class="p">,</span> <span class="mf">0.820267</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">0.086863</span><span class="p">,</span> <span class="mf">0.349722</span><span class="p">],</span>
            <span class="p">[</span><span class="mf">0.003176</span><span class="p">,</span> <span class="mf">0.655448</span><span class="p">]]</span>
      <span class="n">xmw_expected</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">[</span><span class="o">-</span><span class="mf">0.74310219</span><span class="p">,</span> <span class="mf">1.10182762</span><span class="p">,</span> <span class="mf">0.67478961</span><span class="p">,</span> <span class="mf">0.62169313</span><span class="p">,</span> <span class="mf">0.77394271</span><span class="p">,</span>
           <span class="o">-</span><span class="mf">0.1691505</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.39185536</span><span class="p">,</span> <span class="mf">0.87572402</span><span class="p">],</span>
          <span class="p">[</span><span class="o">-</span><span class="mf">0.78952235</span><span class="p">,</span> <span class="mf">0.04464795</span><span class="p">,</span> <span class="mf">0.00245538</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.34931657</span><span class="p">,</span> <span class="mf">0.22463873</span><span class="p">,</span>
           <span class="mf">0.02745318</span><span class="p">,</span> <span class="mf">0.15253648</span><span class="p">,</span> <span class="mf">0.14931624</span><span class="p">],</span>
          <span class="p">[</span><span class="o">-</span><span class="mf">1.58246589</span><span class="p">,</span> <span class="mf">0.03950393</span><span class="p">,</span> <span class="mf">0.18513964</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25745165</span><span class="p">,</span> <span class="mf">0.73317981</span><span class="p">,</span>
           <span class="mf">0.68082684</span><span class="p">,</span> <span class="mf">0.08576801</span><span class="p">,</span> <span class="mf">0.62040436</span><span class="p">]]</span>
      <span class="c1"># pyformat: enable</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">m_expected</span><span class="p">,</span> <span class="n">state1</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">c_expected</span><span class="p">,</span> <span class="n">state1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>
      <span class="c1"># print(&#39;xmw = &#39;, extras.xmw.eval())</span>
      <span class="c1"># self.assertAllClose(xmw_expected, extras.xmw.eval())</span>

<div class="viewcode-block" id="RNNCellTest.testLSTMSimple_NoInline"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testLSTMSimple_NoInline">[docs]</a>  <span class="k">def</span> <span class="nf">testLSTMSimple_NoInline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_testLSTMSimpleHelper</span><span class="p">(</span><span class="n">inline</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="RNNCellTest.testLSTMSimple_Inline"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testLSTMSimple_Inline">[docs]</a>  <span class="k">def</span> <span class="nf">testLSTMSimple_Inline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_testLSTMSimpleHelper</span><span class="p">(</span><span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="RNNCellTest.testCifgLSTMSimple_NoInline"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testCifgLSTMSimple_NoInline">[docs]</a>  <span class="k">def</span> <span class="nf">testCifgLSTMSimple_NoInline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_testLSTMSimpleHelper</span><span class="p">(</span><span class="n">inline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">couple_input_forget_gates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="RNNCellTest.testCifgLSTMSimple_Inline"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testCifgLSTMSimple_Inline">[docs]</a>  <span class="k">def</span> <span class="nf">testCifgLSTMSimple_Inline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_testLSTMSimpleHelper</span><span class="p">(</span><span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">couple_input_forget_gates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="RNNCellTest.testLSTMSimple_Masked"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testLSTMSimple_Masked">[docs]</a>  <span class="k">def</span> <span class="nf">testLSTMSimple_Masked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">(</span>
        <span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">py_utils</span><span class="o">.</span><span class="n">SessionConfig</span><span class="p">(</span><span class="n">inline</span><span class="o">=</span><span class="kc">False</span><span class="p">)):</span>
      <span class="n">params</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LSTMCellSimple</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
      <span class="n">params</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lstm&#39;</span>
      <span class="n">params</span><span class="o">.</span><span class="n">output_nonlinearity</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="n">params</span><span class="o">.</span><span class="n">params_init</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">WeightInit</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1.24</span><span class="p">,</span> <span class="n">_INIT_RANDOM_SEED</span><span class="p">)</span>

      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">global_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">per_step_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_input_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_output_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">apply_pruning</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="n">lstm</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LSTMCellSimple</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;lstm vars = &#39;</span><span class="p">,</span> <span class="n">lstm</span><span class="o">.</span><span class="n">vars</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;wm&#39;</span> <span class="ow">in</span> <span class="n">lstm</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;b&#39;</span> <span class="ow">in</span> <span class="n">lstm</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;mask&#39;</span> <span class="ow">in</span> <span class="n">lstm</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;threshold&#39;</span> <span class="ow">in</span> <span class="n">lstm</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">threshold</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

      <span class="n">num_param_vectors</span> <span class="o">=</span> <span class="mi">8</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">lstm</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span>
                       <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_param_vectors</span><span class="p">]))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">lstm</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span>
                       <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="n">num_param_vectors</span><span class="p">]))</span>

      <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">_NUMPY_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">inputs</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">act</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)],</span>
          <span class="n">padding</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
      <span class="n">state0</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">c</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
          <span class="n">m</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

      <span class="n">state1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">FPropDefaultTheta</span><span class="p">(</span><span class="n">state0</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>

      <span class="c1"># Initialize all the variables, and then run one step.</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

      <span class="n">variable_count</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">wts</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="s1">&#39;LSTMCellSimple_vars&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">variable_count</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">wts</span><span class="p">))</span>

      <span class="n">masks</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="s1">&#39;masks&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">))</span>

      <span class="n">threshold</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="s1">&#39;thresholds&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">threshold</span><span class="p">))</span>

      <span class="n">m_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.095727</span><span class="p">,</span> <span class="mf">0.476658</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.04662</span><span class="p">,</span> <span class="mf">0.180589</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">0.001656</span><span class="p">,</span> <span class="mf">0.374141</span><span class="p">]]</span>
      <span class="n">c_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.241993</span><span class="p">,</span> <span class="mf">0.820267</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.086863</span><span class="p">,</span> <span class="mf">0.349722</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">0.003176</span><span class="p">,</span> <span class="mf">0.655448</span><span class="p">]]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">m_expected</span><span class="p">,</span> <span class="n">state1</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">c_expected</span><span class="p">,</span> <span class="n">state1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span></div>

<div class="viewcode-block" id="RNNCellTest.testLSTMSimple_Projections"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testLSTMSimple_Projections">[docs]</a>  <span class="k">def</span> <span class="nf">testLSTMSimple_Projections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">(</span>
        <span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">py_utils</span><span class="o">.</span><span class="n">SessionConfig</span><span class="p">(</span><span class="n">inline</span><span class="o">=</span><span class="kc">False</span><span class="p">)):</span>
      <span class="n">params</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LSTMCellSimple</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
      <span class="n">params</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lstm&#39;</span>
      <span class="n">params</span><span class="o">.</span><span class="n">output_nonlinearity</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="n">params</span><span class="o">.</span><span class="n">params_init</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">WeightInit</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1.24</span><span class="p">,</span> <span class="n">_INIT_RANDOM_SEED</span><span class="p">)</span>

      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">global_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">per_step_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_input_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_output_nodes</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_hidden_nodes</span> <span class="o">=</span> <span class="mi">2</span>

      <span class="n">lstm</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LSTMCellSimple</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;lstm vars = &#39;</span><span class="p">,</span> <span class="n">lstm</span><span class="o">.</span><span class="n">vars</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;wm&#39;</span> <span class="ow">in</span> <span class="n">lstm</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;b&#39;</span> <span class="ow">in</span> <span class="n">lstm</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">lstm</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">]))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">lstm</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="mi">8</span><span class="p">]))</span>

      <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">_NUMPY_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">inputs</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">act</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)],</span>
          <span class="n">padding</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
      <span class="n">state0</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">c</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
          <span class="n">m</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

      <span class="n">state1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">FPropDefaultTheta</span><span class="p">(</span><span class="n">state0</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>

      <span class="c1"># Initialize all the variables, and then run one step.</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

      <span class="n">variable_count</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># weights, biases, projection.</span>
      <span class="n">wts</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="s1">&#39;LSTMCellSimple_vars&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">variable_count</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">wts</span><span class="p">))</span>

      <span class="n">m_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.414049</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.076521</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.356313</span><span class="p">]]</span>
      <span class="n">c_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.270425</span><span class="p">,</span> <span class="mf">0.840373</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.349856</span><span class="p">,</span> <span class="mf">0.440421</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">0.261243</span><span class="p">,</span> <span class="mf">0.889804</span><span class="p">]]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">m_expected</span><span class="p">,</span> <span class="n">state1</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">c_expected</span><span class="p">,</span> <span class="n">state1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span></div>

<div class="viewcode-block" id="RNNCellTest.testLSTMSimpleGroupedWithoutShuffling"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testLSTMSimpleGroupedWithoutShuffling">[docs]</a>  <span class="k">def</span> <span class="nf">testLSTMSimpleGroupedWithoutShuffling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_testLSTMSimpleGrouped</span><span class="p">(</span><span class="n">num_shuffle_shards</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="RNNCellTest.testLSTMSimpleGroupedWithOutputShuffling"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testLSTMSimpleGroupedWithOutputShuffling">[docs]</a>  <span class="k">def</span> <span class="nf">testLSTMSimpleGroupedWithOutputShuffling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_testLSTMSimpleGrouped</span><span class="p">(</span><span class="n">num_shuffle_shards</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

  <span class="k">def</span> <span class="nf">_testLSTMSimpleGrouped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_shuffle_shards</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">(</span>
        <span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">py_utils</span><span class="o">.</span><span class="n">SessionConfig</span><span class="p">(</span><span class="n">inline</span><span class="o">=</span><span class="kc">False</span><span class="p">)):</span>
      <span class="n">params</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LSTMCellGrouped</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
      <span class="n">params</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lstm&#39;</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_input_nodes</span> <span class="o">=</span> <span class="mi">8</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_output_nodes</span> <span class="o">=</span> <span class="mi">8</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_groups</span> <span class="o">=</span> <span class="mi">4</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_shuffle_shards</span> <span class="o">=</span> <span class="n">num_shuffle_shards</span>
      <span class="n">child_p</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">child_lstm_tpl</span>
      <span class="n">child_p</span><span class="o">.</span><span class="n">output_nonlinearity</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="n">child_p</span><span class="o">.</span><span class="n">params_init</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">WeightInit</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1.24</span><span class="p">,</span> <span class="n">_INIT_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">child_p</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">global_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">child_p</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">per_step_vn</span> <span class="o">=</span> <span class="kc">False</span>

      <span class="n">lstm</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">cls</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;lstm vars = &#39;</span><span class="p">,</span> <span class="n">lstm</span><span class="o">.</span><span class="n">vars</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">child_lstm</span> <span class="ow">in</span> <span class="n">lstm</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;wm&#39;</span> <span class="ow">in</span> <span class="n">child_lstm</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;b&#39;</span> <span class="ow">in</span> <span class="n">child_lstm</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">child_lstm</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span>
                                                                          <span class="mi">8</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">child_lstm</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="mi">8</span><span class="p">]))</span>

      <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">_NUMPY_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">inputs</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">act</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)],</span>
          <span class="n">padding</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
      <span class="n">state0</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">groups</span><span class="o">=</span><span class="n">py_utils</span><span class="o">.</span><span class="n">SplitRecursively</span><span class="p">(</span>
              <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
                  <span class="n">c</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                  <span class="n">m</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span>
                      <span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span> <span class="n">params</span><span class="o">.</span><span class="n">num_groups</span><span class="p">))</span>

      <span class="n">state1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">FPropDefaultTheta</span><span class="p">(</span><span class="n">state0</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">num_groups</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">state1</span><span class="o">.</span><span class="n">groups</span><span class="p">))</span>
      <span class="n">out1</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">(</span><span class="n">state1</span><span class="p">)</span>

      <span class="c1"># Initialize all the variables, and then run one step.</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

      <span class="n">variable_count</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">num_groups</span>  <span class="c1"># one for weights, one for biases.</span>
      <span class="n">wts</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="s1">&#39;LSTMCellSimple_vars&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">variable_count</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">wts</span><span class="p">))</span>

      <span class="n">state1</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">ConcatRecursively</span><span class="p">(</span><span class="n">state1</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span>
      <span class="n">m_actual</span> <span class="o">=</span> <span class="n">state1</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
      <span class="n">c_actual</span> <span class="o">=</span> <span class="n">state1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
      <span class="n">out_actual</span> <span class="o">=</span> <span class="n">out1</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;m_actual =&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array_repr</span><span class="p">(</span><span class="n">m_actual</span><span class="p">))</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c_actual =&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array_repr</span><span class="p">(</span><span class="n">c_actual</span><span class="p">))</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;out_actual =&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array_repr</span><span class="p">(</span><span class="n">out_actual</span><span class="p">))</span>

      <span class="c1"># pylint: disable=bad-whitespace, line-too-long</span>
      <span class="n">m_expected</span> <span class="o">=</span> <span class="p">[[</span>
          <span class="o">-</span><span class="mf">0.07857136</span><span class="p">,</span> <span class="mf">0.43932292</span><span class="p">,</span> <span class="mf">0.11373602</span><span class="p">,</span> <span class="mf">0.16337454</span><span class="p">,</span> <span class="mf">0.01618987</span><span class="p">,</span>
          <span class="mf">0.09685542</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.20168062</span><span class="p">,</span> <span class="mf">0.52612996</span>
      <span class="p">],</span> <span class="p">[</span>
          <span class="mf">0.07929622</span><span class="p">,</span> <span class="mf">0.18910739</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.11084013</span><span class="p">,</span> <span class="mf">0.32307294</span><span class="p">,</span> <span class="mf">0.03500029</span><span class="p">,</span>
          <span class="o">-</span><span class="mf">0.05823045</span><span class="p">,</span> <span class="mf">0.16963124</span><span class="p">,</span> <span class="mf">0.27039385</span>
      <span class="p">],</span> <span class="p">[</span>
          <span class="mf">0.11623365</span><span class="p">,</span> <span class="mf">0.38104215</span><span class="p">,</span> <span class="mf">0.00935007</span><span class="p">,</span> <span class="mf">0.22124135</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.17368057</span><span class="p">,</span>
          <span class="mf">0.10859803</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.06948104</span><span class="p">,</span> <span class="mf">0.10925373</span>
      <span class="p">]]</span>
      <span class="n">c_expected</span> <span class="o">=</span> <span class="p">[[</span>
          <span class="o">-</span><span class="mf">0.23670214</span><span class="p">,</span> <span class="mf">0.66260374</span><span class="p">,</span> <span class="mf">0.24650344</span><span class="p">,</span> <span class="mf">0.28946888</span><span class="p">,</span> <span class="mf">0.03051668</span><span class="p">,</span>
          <span class="mf">0.15143034</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.52736223</span><span class="p">,</span> <span class="mf">0.88325077</span>
      <span class="p">],</span> <span class="p">[</span>
          <span class="mf">0.16262427</span><span class="p">,</span> <span class="mf">0.28568456</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.19542629</span><span class="p">,</span> <span class="mf">0.52116692</span><span class="p">,</span> <span class="mf">0.06872599</span><span class="p">,</span>
          <span class="o">-</span><span class="mf">0.1123996</span><span class="p">,</span> <span class="mf">0.31477568</span><span class="p">,</span> <span class="mf">0.49881396</span>
      <span class="p">],</span> <span class="p">[</span>
          <span class="mf">0.19667494</span><span class="p">,</span> <span class="mf">0.68746102</span><span class="p">,</span> <span class="mf">0.02078706</span><span class="p">,</span> <span class="mf">0.30816019</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.36376655</span><span class="p">,</span>
          <span class="mf">0.16003416</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.16141629</span><span class="p">,</span> <span class="mf">0.16648693</span>
      <span class="p">]]</span>
      <span class="n">out_expected</span> <span class="o">=</span> <span class="n">m_expected</span>
      <span class="c1"># pylint: enable=bad-whitespace, line-too-long</span>
      <span class="k">if</span> <span class="n">num_shuffle_shards</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">_ShuffleShards</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
          <span class="k">return</span> <span class="p">[[</span><span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

        <span class="k">assert</span> <span class="n">num_shuffle_shards</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">out_expected</span> <span class="o">=</span> <span class="n">_ShuffleShards</span><span class="p">(</span><span class="n">out_expected</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">m_expected</span><span class="p">,</span> <span class="n">m_actual</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">c_expected</span><span class="p">,</span> <span class="n">c_actual</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">out_expected</span><span class="p">,</span> <span class="n">out_actual</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_testLSTMSimple_VN</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
      <span class="n">params</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LSTMCellSimple</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
      <span class="n">params</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lstm&#39;</span>
      <span class="n">params</span><span class="o">.</span><span class="n">output_nonlinearity</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="n">params</span><span class="o">.</span><span class="n">params_init</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">WeightInit</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1.24</span><span class="p">,</span> <span class="n">_INIT_RANDOM_SEED</span><span class="p">)</span>

      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="mi">8820495</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">global_vn</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">per_step_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mf">0.5</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_input_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_output_nodes</span> <span class="o">=</span> <span class="mi">2</span>

      <span class="n">lstm</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LSTMCellSimple</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

      <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">_NUMPY_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">inputs</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">act</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)],</span>
          <span class="n">padding</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
      <span class="n">state0</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">c</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
          <span class="n">m</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

      <span class="n">state1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">FPropDefaultTheta</span><span class="p">(</span><span class="n">state0</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>

      <span class="c1"># Initialize all the variables, and then run one step.</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

      <span class="c1"># pyformat: disable</span>
      <span class="n">m_expected</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">[</span><span class="mf">0.080182</span><span class="p">,</span> <span class="mf">0.4585</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">0.050852</span><span class="p">,</span> <span class="mf">0.245296</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">0.023557</span><span class="p">,</span> <span class="mf">0.382329</span><span class="p">]]</span>
      <span class="n">c_expected</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">[</span><span class="mf">0.387777</span><span class="p">,</span> <span class="mf">0.819644</span><span class="p">],</span>
          <span class="p">[</span><span class="o">-</span><span class="mf">0.160634</span><span class="p">,</span> <span class="mf">0.513716</span><span class="p">],</span>
          <span class="p">[</span><span class="o">-</span><span class="mf">0.179584</span><span class="p">,</span> <span class="mf">0.862915</span><span class="p">]]</span>
      <span class="c1"># pyformat: enable</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">m_expected</span><span class="p">,</span> <span class="n">state1</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">c_expected</span><span class="p">,</span> <span class="n">state1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>

<div class="viewcode-block" id="RNNCellTest.testLSTMSimple_GlobalNoise"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testLSTMSimple_GlobalNoise">[docs]</a>  <span class="k">def</span> <span class="nf">testLSTMSimple_GlobalNoise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_testLSTMSimple_VN</span><span class="p">()</span></div>

<div class="viewcode-block" id="RNNCellTest.testLSTMSimpleDouble"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testLSTMSimpleDouble">[docs]</a>  <span class="k">def</span> <span class="nf">testLSTMSimpleDouble</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
      <span class="n">params</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LSTMCellSimple</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
      <span class="n">params</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lstm&#39;</span>
      <span class="n">params</span><span class="o">.</span><span class="n">output_nonlinearity</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="n">params</span><span class="o">.</span><span class="n">params_init</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">WeightInit</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1.24</span><span class="p">,</span> <span class="n">_INIT_RANDOM_SEED</span><span class="p">)</span>

      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="mi">8820495</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">global_vn</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">per_step_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mf">0.5</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_input_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_output_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float64</span>

      <span class="n">lstm</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LSTMCellSimple</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

      <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">_NUMPY_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">inputs</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">act</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float64</span><span class="p">)],</span>
          <span class="n">padding</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
      <span class="n">state0</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">c</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
          <span class="n">m</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
      <span class="n">state1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">FPropDefaultTheta</span><span class="p">(</span><span class="n">state0</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>

      <span class="c1"># Initialize all the variables, and then run one step.</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

      <span class="c1"># pyformat: disable</span>
      <span class="n">m_expected</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">[</span><span class="mf">0.3472136</span><span class="p">,</span> <span class="mf">0.11880029</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">0.14214374</span><span class="p">,</span> <span class="mf">0.33760977</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">0.1168568</span><span class="p">,</span> <span class="mf">0.32053401</span><span class="p">]]</span>
      <span class="n">c_expected</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">[</span><span class="mf">1.46477364</span><span class="p">,</span> <span class="mf">0.43743008</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">0.57051592</span><span class="p">,</span> <span class="mf">0.14892339</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">0.6949858</span><span class="p">,</span> <span class="mf">0.16326128</span><span class="p">]]</span>
      <span class="c1"># pyformat: enable</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">m_expected</span><span class="p">,</span> <span class="n">state1</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">c_expected</span><span class="p">,</span> <span class="n">state1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span></div>

<div class="viewcode-block" id="RNNCellTest.testLSTMSimpleNoOutputNonlinearity"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testLSTMSimpleNoOutputNonlinearity">[docs]</a>  <span class="k">def</span> <span class="nf">testLSTMSimpleNoOutputNonlinearity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
      <span class="n">params</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LSTMCellSimple</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
      <span class="n">params</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lstm&#39;</span>
      <span class="n">params</span><span class="o">.</span><span class="n">output_nonlinearity</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float64</span>
      <span class="n">params</span><span class="o">.</span><span class="n">cell_value_cap</span> <span class="o">=</span> <span class="mf">10.0</span>
      <span class="n">params</span><span class="o">.</span><span class="n">params_init</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">WeightInit</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1.24</span><span class="p">,</span> <span class="n">_INIT_RANDOM_SEED</span><span class="p">)</span>

      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">global_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">per_step_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_input_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_output_nodes</span> <span class="o">=</span> <span class="mi">2</span>

      <span class="n">lstm</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LSTMCellSimple</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

      <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">_NUMPY_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">inputs</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">act</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float64</span><span class="p">)],</span>
          <span class="n">padding</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
      <span class="n">state0</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">c</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
          <span class="n">m</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
      <span class="n">state1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">FPropDefaultTheta</span><span class="p">(</span><span class="n">state0</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>

      <span class="c1"># Initialize all the variables, and then run one step.</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

      <span class="n">wts</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="s1">&#39;LSTMCellSimple_vars&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">wts</span><span class="p">))</span>

      <span class="c1"># pyformat: disable</span>
      <span class="n">m_expected</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">[</span><span class="mf">0.532625</span><span class="p">,</span> <span class="mf">0.083511</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">0.118662</span><span class="p">,</span> <span class="mf">0.110532</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">0.121542</span><span class="p">,</span> <span class="mf">0.084161</span><span class="p">]]</span>
      <span class="n">c_expected</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">[</span><span class="mf">0.789908</span><span class="p">,</span> <span class="mf">0.312811</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">0.192642</span><span class="p">,</span> <span class="mf">0.207369</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">0.167591</span><span class="p">,</span> <span class="mf">0.172713</span><span class="p">]]</span>
      <span class="c1"># pyformat: enable</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">m_expected</span><span class="p">,</span> <span class="n">state1</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">c_expected</span><span class="p">,</span> <span class="n">state1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span></div>

<div class="viewcode-block" id="RNNCellTest.testLSTMSimpleBypass"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testLSTMSimpleBypass">[docs]</a>  <span class="k">def</span> <span class="nf">testLSTMSimpleBypass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
      <span class="n">params</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LSTMCellSimple</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
      <span class="n">params</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lstm&#39;</span>
      <span class="n">params</span><span class="o">.</span><span class="n">output_nonlinearity</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float64</span>
      <span class="n">params</span><span class="o">.</span><span class="n">cell_value_cap</span> <span class="o">=</span> <span class="mf">10.0</span>
      <span class="n">params</span><span class="o">.</span><span class="n">params_init</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">WeightInit</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1.24</span><span class="p">,</span> <span class="n">_INIT_RANDOM_SEED</span><span class="p">)</span>

      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">global_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">per_step_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_input_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_output_nodes</span> <span class="o">=</span> <span class="mi">2</span>

      <span class="n">lstm</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LSTMCellSimple</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

      <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">_NUMPY_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">inputs</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">act</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float64</span><span class="p">)],</span>
          <span class="n">padding</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
      <span class="n">state0</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">c</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
          <span class="n">m</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
      <span class="n">state1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">FPropDefaultTheta</span><span class="p">(</span><span class="n">state0</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>

      <span class="c1"># Initialize all the variables, and then run one step.</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

      <span class="n">wts</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="s1">&#39;LSTMCellSimple_vars&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">wts</span><span class="p">))</span>

      <span class="c1"># pyformat: enable</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">state0</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">eval</span><span class="p">(),</span> <span class="n">state1</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">state0</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">eval</span><span class="p">(),</span> <span class="n">state1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span></div>

<div class="viewcode-block" id="RNNCellTest.testLSTMCuDNNCompliant"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testLSTMCuDNNCompliant">[docs]</a>  <span class="k">def</span> <span class="nf">testLSTMCuDNNCompliant</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tf</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">is_gpu_available</span><span class="p">(</span><span class="n">cuda_only</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
      <span class="k">return</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">input_nodes</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">cell_nodes</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>

    <span class="c1"># LSTM inputs and states constants.</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">_NUMPY_RANDOM_SEED</span><span class="p">)</span>
    <span class="n">inputs_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">input_nodes</span><span class="p">))</span>
    <span class="n">paddings_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c1"># The last example is padded.</span>
    <span class="n">paddings_v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">h_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">cell_nodes</span><span class="p">))</span>
    <span class="n">c_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">cell_nodes</span><span class="p">))</span>
    <span class="n">cudnn_helper</span> <span class="o">=</span> <span class="n">cudnn_rnn_utils</span><span class="o">.</span><span class="n">CuDNNLSTMInitializer</span><span class="p">(</span>
        <span class="n">input_nodes</span><span class="p">,</span> <span class="n">cell_nodes</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">UNI_RNN</span><span class="p">)</span>

    <span class="c1"># tf CuDNN LSTM</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">use_gpu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">())</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
      <span class="n">inputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">inputs_v</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">state_h</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">h_v</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">state_c</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">c_v</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">cudnn_params</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span>
          <span class="s1">&#39;cudnn_opaque_params&#39;</span><span class="p">,</span>
          <span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">random_uniform</span><span class="p">(</span>
              <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">cudnn_helper</span><span class="o">.</span><span class="n">OpaqueParamsShape</span><span class="p">(</span><span class="n">dtype</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">),</span>
          <span class="n">validate_shape</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

      <span class="n">outputs</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">gen_cudnn_rnn_ops</span><span class="o">.</span><span class="n">cudnn_rnn</span><span class="p">(</span>
          <span class="nb">input</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
          <span class="n">input_h</span><span class="o">=</span><span class="n">state_h</span><span class="p">,</span>
          <span class="n">input_c</span><span class="o">=</span><span class="n">state_c</span><span class="p">,</span>
          <span class="n">params</span><span class="o">=</span><span class="n">cudnn_params</span><span class="p">,</span>
          <span class="n">rnn_mode</span><span class="o">=</span><span class="s1">&#39;lstm&#39;</span><span class="p">,</span>
          <span class="n">input_mode</span><span class="o">=</span><span class="s1">&#39;linear_input&#39;</span><span class="p">,</span>
          <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;unidirectional&#39;</span><span class="p">,</span>
          <span class="n">dropout</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
          <span class="n">is_training</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="n">outputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">paddings_v</span><span class="p">)</span>
      <span class="n">h</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">paddings_v</span><span class="p">)</span>
      <span class="n">c</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">paddings_v</span><span class="p">)</span>

      <span class="c1"># Initialize all the variables, and then run one step.</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
      <span class="n">cudnn_params_v</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cudnn_params</span><span class="p">)</span>
      <span class="n">cudnn_outputs_v</span><span class="p">,</span> <span class="n">cudnn_h_v</span><span class="p">,</span> <span class="n">cudnn_c_v</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">outputs</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">])</span>

    <span class="c1"># LSTMCellCuDNNCompliant</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">())</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
      <span class="n">p</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LSTMCellCuDNNCompliant</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
      <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lstm_cell_cudnn&#39;</span>
      <span class="n">p</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>
      <span class="n">p</span><span class="o">.</span><span class="n">num_input_nodes</span> <span class="o">=</span> <span class="n">input_nodes</span>
      <span class="n">p</span><span class="o">.</span><span class="n">num_output_nodes</span> <span class="o">=</span> <span class="n">cell_nodes</span>
      <span class="n">lstm</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LSTMCellCuDNNCompliant</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

      <span class="n">assign_op</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">lstm</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">wb</span><span class="p">,</span> <span class="n">cudnn_params_v</span><span class="p">)</span>

      <span class="n">inputs</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">act</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">inputs_v</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">dtype</span><span class="p">)],</span>
          <span class="n">padding</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">paddings_v</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
      <span class="n">state0</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">m</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">h_v</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">c_v</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">))</span>
      <span class="n">state1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">FPropDefaultTheta</span><span class="p">(</span><span class="n">state0</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
      <span class="n">state1</span><span class="o">.</span><span class="n">m</span> <span class="o">*=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">paddings_v</span>
      <span class="n">state1</span><span class="o">.</span><span class="n">c</span> <span class="o">*=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">paddings_v</span>

      <span class="c1"># Initialize all the variables, and then run one step.</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
      <span class="n">assign_op</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
      <span class="n">outputs_v</span><span class="p">,</span> <span class="n">h_v</span><span class="p">,</span> <span class="n">c_v</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">state1</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">state1</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">state1</span><span class="o">.</span><span class="n">c</span><span class="p">])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">cudnn_outputs_v</span><span class="p">,</span> <span class="n">outputs_v</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">cudnn_h_v</span><span class="p">,</span> <span class="n">h_v</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">cudnn_c_v</span><span class="p">,</span> <span class="n">c_v</span><span class="p">)</span></div>

  <span class="k">def</span> <span class="nf">_testConvLSTMHelper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">(</span>
        <span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">py_utils</span><span class="o">.</span><span class="n">SessionConfig</span><span class="p">(</span><span class="n">inline</span><span class="o">=</span><span class="n">inline</span><span class="p">)):</span>
      <span class="n">params</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">ConvLSTMCell</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
      <span class="n">params</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;conv_lstm&#39;</span>
      <span class="n">params</span><span class="o">.</span><span class="n">output_nonlinearity</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="n">params</span><span class="o">.</span><span class="n">params_init</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">WeightInit</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1.24</span><span class="p">,</span> <span class="n">_INIT_RANDOM_SEED</span><span class="p">)</span>

      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">global_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">per_step_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">inputs_shape</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
      <span class="n">params</span><span class="o">.</span><span class="n">cell_shape</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
      <span class="n">params</span><span class="o">.</span><span class="n">filter_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>

      <span class="n">lstm</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">ConvLSTMCell</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

      <span class="n">lstm_vars</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">vars</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;lstm vars = &#39;</span><span class="p">,</span> <span class="n">lstm_vars</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;wm&#39;</span> <span class="ow">in</span> <span class="n">lstm_vars</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;b&#39;</span> <span class="ow">in</span> <span class="n">lstm_vars</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

      <span class="n">w</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">wm</span>
      <span class="n">b</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">b</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">]))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="mi">8</span><span class="p">]))</span>

      <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">_NUMPY_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">inputs</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">act</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)],</span>
          <span class="n">padding</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
      <span class="n">state0</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">c</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
          <span class="n">m</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
      <span class="n">state1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">FPropDefaultTheta</span><span class="p">(</span><span class="n">state0</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
      <span class="n">m1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">state1</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
      <span class="n">c1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">state1</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

      <span class="c1"># Initialize all the variables, and then run one step.</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

      <span class="n">wts</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="s1">&#39;ConvLSTMCell_vars&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">wts</span><span class="p">))</span>

      <span class="c1"># pyformat: disable</span>
      <span class="n">m_expected</span> <span class="o">=</span> <span class="p">[</span>
          <span class="mf">0.4144063</span><span class="p">,</span> <span class="mf">0.88831079</span><span class="p">,</span> <span class="mf">0.56665027</span><span class="p">,</span> <span class="mf">0.30154669</span><span class="p">,</span> <span class="mf">0.2818037</span><span class="p">]</span>
      <span class="n">c_expected</span> <span class="o">=</span> <span class="p">[</span>
          <span class="mf">4.72228432</span><span class="p">,</span> <span class="mf">3.9454143</span><span class="p">,</span> <span class="mf">3.77556086</span><span class="p">,</span> <span class="mf">2.76972866</span><span class="p">,</span> <span class="mf">1.87397099</span><span class="p">]</span>
      <span class="c1"># print(&#39;m1.eval&#39;, m1.eval())</span>
      <span class="c1"># print(&#39;c1.eval&#39;, c1.eval())</span>
      <span class="c1"># pyformat: enable</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">m_expected</span><span class="p">,</span> <span class="n">m1</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">c_expected</span><span class="p">,</span> <span class="n">c1</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>

<div class="viewcode-block" id="RNNCellTest.testConvLSTM_NoInline"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testConvLSTM_NoInline">[docs]</a>  <span class="k">def</span> <span class="nf">testConvLSTM_NoInline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_testConvLSTMHelper</span><span class="p">(</span><span class="n">inline</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="RNNCellTest.testConvLSTM_Inline"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testConvLSTM_Inline">[docs]</a>  <span class="k">def</span> <span class="nf">testConvLSTM_Inline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_testConvLSTMHelper</span><span class="p">(</span><span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

  <span class="k">def</span> <span class="nf">_testConvLSTM_VN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">per_step_vn</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
      <span class="n">params</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">ConvLSTMCell</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
      <span class="n">params</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;conv_lstm&#39;</span>
      <span class="n">params</span><span class="o">.</span><span class="n">output_nonlinearity</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="n">params</span><span class="o">.</span><span class="n">params_init</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">WeightInit</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1.24</span><span class="p">,</span> <span class="n">_INIT_RANDOM_SEED</span><span class="p">)</span>

      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="mi">8820495</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">global_vn</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">per_step_vn</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">per_step_vn</span> <span class="o">=</span> <span class="n">per_step_vn</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mf">0.5</span>

      <span class="n">params</span><span class="o">.</span><span class="n">inputs_shape</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
      <span class="n">params</span><span class="o">.</span><span class="n">cell_shape</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
      <span class="n">params</span><span class="o">.</span><span class="n">filter_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>

      <span class="n">lstm</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">ConvLSTMCell</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

      <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">_NUMPY_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">inputs</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">act</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)],</span>
          <span class="n">padding</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
      <span class="n">state0</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">c</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
          <span class="n">m</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
      <span class="n">state1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">FPropDefaultTheta</span><span class="p">(</span><span class="n">state0</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
      <span class="n">m1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">state1</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
      <span class="n">c1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">state1</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

      <span class="c1"># Initialize all the variables, and then run one step.</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

      <span class="c1"># pyformat: disable</span>
      <span class="n">m_expected</span> <span class="o">=</span> <span class="p">[</span>
          <span class="mf">0.21634784</span><span class="p">,</span> <span class="mf">0.40635043</span><span class="p">,</span> <span class="mf">0.12228709</span><span class="p">,</span> <span class="mf">0.51806468</span><span class="p">,</span> <span class="mf">0.02064975</span><span class="p">]</span>
      <span class="n">c_expected</span> <span class="o">=</span> <span class="p">[</span>
          <span class="mf">5.21427298</span><span class="p">,</span> <span class="mf">4.5560832</span><span class="p">,</span> <span class="mf">4.24992609</span><span class="p">,</span> <span class="mf">3.85193706</span><span class="p">,</span> <span class="mf">2.35372424</span><span class="p">]</span>
      <span class="c1"># print(&#39;m1.eval&#39;, np.array_repr(m1.eval()))</span>
      <span class="c1"># print(&#39;c1.eval&#39;, np.array_repr(c1.eval()))</span>
      <span class="c1"># pyformat: enable</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">m_expected</span><span class="p">,</span> <span class="n">m1</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">c_expected</span><span class="p">,</span> <span class="n">c1</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>

<div class="viewcode-block" id="RNNCellTest.testConvLSTM_GlobalNoise"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testConvLSTM_GlobalNoise">[docs]</a>  <span class="k">def</span> <span class="nf">testConvLSTM_GlobalNoise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_testConvLSTM_VN</span><span class="p">(</span><span class="n">per_step_vn</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="RNNCellTest.testLSTMSimpleWithForgetGateBias"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testLSTMSimpleWithForgetGateBias">[docs]</a>  <span class="k">def</span> <span class="nf">testLSTMSimpleWithForgetGateBias</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
      <span class="n">params</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LSTMCellSimple</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
      <span class="n">params</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lstm&#39;</span>
      <span class="n">params</span><span class="o">.</span><span class="n">output_nonlinearity</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="n">params</span><span class="o">.</span><span class="n">params_init</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">WeightInit</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1.24</span><span class="p">,</span> <span class="n">_INIT_RANDOM_SEED</span><span class="p">)</span>

      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="mi">8820495</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">global_vn</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">per_step_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mf">0.5</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_input_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_output_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">forget_gate_bias</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
      <span class="n">params</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float64</span>

      <span class="n">lstm</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LSTMCellSimple</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

      <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">_NUMPY_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">inputs</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">act</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float64</span><span class="p">)],</span>
          <span class="n">padding</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
      <span class="n">state0</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">c</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
          <span class="n">m</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
      <span class="n">state1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">FPropDefaultTheta</span><span class="p">(</span><span class="n">state0</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>

      <span class="c1"># Initialize all the variables, and then run one step.</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

      <span class="c1"># pyformat: disable</span>
      <span class="n">m_expected</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">[</span><span class="mf">0.19534954</span><span class="p">,</span> <span class="mf">0.10979363</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">0.02134449</span><span class="p">,</span> <span class="mf">0.2821926</span><span class="p">],</span>
          <span class="p">[</span><span class="o">-</span><span class="mf">0.02530111</span><span class="p">,</span> <span class="mf">0.25382254</span><span class="p">]]</span>
      <span class="n">c_expected</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">[</span><span class="mf">1.29934979</span><span class="p">,</span> <span class="mf">0.31769676</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">0.41655035</span><span class="p">,</span> <span class="mf">0.05172589</span><span class="p">],</span>
          <span class="p">[</span><span class="mf">0.58909841</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.00438461</span><span class="p">]]</span>
      <span class="c1"># pyformat: enable</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">m_expected</span><span class="p">,</span> <span class="n">state1</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">c_expected</span><span class="p">,</span> <span class="n">state1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span></div>

<div class="viewcode-block" id="RNNCellTest.testZoneOut_Disabled"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testZoneOut_Disabled">[docs]</a>  <span class="k">def</span> <span class="nf">testZoneOut_Disabled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
      <span class="n">prev_v</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]]</span>
      <span class="n">cur_v</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.4</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">3.4</span><span class="p">]]</span>
      <span class="n">padding_v</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]]</span>
      <span class="n">new_v</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">ZoneOut</span><span class="p">(</span>
          <span class="n">prev_v</span><span class="p">,</span>
          <span class="n">cur_v</span><span class="p">,</span>
          <span class="n">padding_v</span><span class="p">,</span>
          <span class="n">zo_prob</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
          <span class="n">is_eval</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
          <span class="n">random_uniform</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
      <span class="n">v_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">2.4</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">3.4</span><span class="p">]]</span>
      <span class="n">new_v_evaled</span> <span class="o">=</span> <span class="n">new_v</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array_repr</span><span class="p">(</span><span class="n">new_v_evaled</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">v_expected</span><span class="p">,</span> <span class="n">new_v_evaled</span><span class="p">)</span></div>

<div class="viewcode-block" id="RNNCellTest.testZoneOut_Enabled"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testZoneOut_Enabled">[docs]</a>  <span class="k">def</span> <span class="nf">testZoneOut_Enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
      <span class="n">prev_v</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]]</span>
      <span class="n">cur_v</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.4</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">3.4</span><span class="p">]]</span>
      <span class="n">padding_v</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]]</span>
      <span class="n">new_v</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">ZoneOut</span><span class="p">(</span>
          <span class="n">prev_v</span><span class="p">,</span>
          <span class="n">cur_v</span><span class="p">,</span>
          <span class="n">padding_v</span><span class="p">,</span>
          <span class="n">zo_prob</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
          <span class="n">is_eval</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
          <span class="n">random_uniform</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">random_uniform</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">seed</span><span class="o">=</span><span class="mi">98798202</span><span class="p">))</span>
      <span class="n">v_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]]</span>
      <span class="n">new_v_evaled</span> <span class="o">=</span> <span class="n">new_v</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array_repr</span><span class="p">(</span><span class="n">new_v_evaled</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">v_expected</span><span class="p">,</span> <span class="n">new_v_evaled</span><span class="p">)</span></div>

<div class="viewcode-block" id="RNNCellTest.testZoneOut_Eval"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testZoneOut_Eval">[docs]</a>  <span class="k">def</span> <span class="nf">testZoneOut_Eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
      <span class="n">prev_v</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]]</span>
      <span class="n">cur_v</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.4</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">3.4</span><span class="p">]]</span>
      <span class="n">padding_v</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]]</span>
      <span class="n">new_v</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">ZoneOut</span><span class="p">(</span>
          <span class="n">prev_v</span><span class="p">,</span>
          <span class="n">cur_v</span><span class="p">,</span>
          <span class="n">padding_v</span><span class="p">,</span>
          <span class="n">zo_prob</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
          <span class="n">is_eval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
          <span class="n">random_uniform</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
      <span class="c1"># In eval mode, if padding[i] == 1, new_v equals prev_v.</span>
      <span class="c1"># Otherwise, new_v = zo_prob * prev_v + (1.0 - zo_prob) * cur_v</span>
      <span class="n">v_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">1.95</span><span class="p">]]</span>
      <span class="n">new_v_evaled</span> <span class="o">=</span> <span class="n">new_v</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array_repr</span><span class="p">(</span><span class="n">new_v_evaled</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">v_expected</span><span class="p">,</span> <span class="n">new_v_evaled</span><span class="p">)</span></div>

<div class="viewcode-block" id="RNNCellTest.testLSTMSimpleWithZoneOut"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testLSTMSimpleWithZoneOut">[docs]</a>  <span class="k">def</span> <span class="nf">testLSTMSimpleWithZoneOut</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
      <span class="n">params</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LSTMCellSimple</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
      <span class="n">params</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lstm&#39;</span>
      <span class="n">params</span><span class="o">.</span><span class="n">output_nonlinearity</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="n">params</span><span class="o">.</span><span class="n">params_init</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">WeightInit</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1.24</span><span class="p">,</span> <span class="n">_INIT_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">global_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">per_step_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_input_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_output_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">zo_prob</span> <span class="o">=</span> <span class="mf">0.5</span>
      <span class="n">params</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="n">_RANDOM_SEED</span>

      <span class="n">lstm</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LSTMCellSimple</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

      <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">_NUMPY_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">inputs</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">act</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)],</span>
          <span class="n">padding</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
      <span class="n">state0</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">c</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
          <span class="n">m</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
      <span class="n">state1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">FPropDefaultTheta</span><span class="p">(</span><span class="n">state0</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>

      <span class="c1"># Initialize all the variables, and then run one step.</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

      <span class="n">m_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0083883</span><span class="p">,</span> <span class="mf">0.10644437</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.04662009</span><span class="p">,</span> <span class="mf">0.18058866</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">0.0016561</span><span class="p">,</span> <span class="mf">0.37414068</span><span class="p">]]</span>
      <span class="n">c_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.96451449</span><span class="p">,</span> <span class="mf">0.65317708</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.08686253</span><span class="p">,</span> <span class="mf">0.34972212</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">0.00317609</span><span class="p">,</span> <span class="mf">0.6554482</span><span class="p">]]</span>
      <span class="n">m_v</span> <span class="o">=</span> <span class="n">state1</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
      <span class="n">c_v</span> <span class="o">=</span> <span class="n">state1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;m_v&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array_repr</span><span class="p">(</span><span class="n">m_v</span><span class="p">))</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c_v&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array_repr</span><span class="p">(</span><span class="n">c_v</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">m_expected</span><span class="p">,</span> <span class="n">m_v</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">c_expected</span><span class="p">,</span> <span class="n">c_v</span><span class="p">)</span></div>

  <span class="k">def</span> <span class="nf">_testLSTMSimpleDeterministicWithZoneOutHelper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed_dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
      <span class="n">params</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LSTMCellSimpleDeterministic</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
      <span class="n">params</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lstm&#39;</span>
      <span class="n">params</span><span class="o">.</span><span class="n">output_nonlinearity</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="n">params</span><span class="o">.</span><span class="n">params_init</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">WeightInit</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1.24</span><span class="p">,</span> <span class="n">_INIT_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">global_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">per_step_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_input_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_output_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">zo_prob</span> <span class="o">=</span> <span class="mf">0.5</span>
      <span class="n">params</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="n">_RANDOM_SEED</span>

      <span class="n">lstm</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LSTMCellSimpleDeterministic</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

      <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">_NUMPY_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">inputs</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">act</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)],</span>
          <span class="n">padding</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
      <span class="n">state0</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">zero_state</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
      <span class="n">state1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">FPropDefaultTheta</span><span class="p">(</span><span class="n">state0</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>

      <span class="c1"># Initialize all the variables, and then run one step.</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

      <span class="n">m_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mf">0.145889</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.008282</span><span class="p">,</span> <span class="mf">0.073219</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.041057</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]]</span>
      <span class="n">c_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.532332</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.016117</span><span class="p">,</span> <span class="mf">0.13752</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]]</span>
      <span class="n">m_v</span> <span class="o">=</span> <span class="n">state1</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
      <span class="n">c_v</span> <span class="o">=</span> <span class="n">state1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;m_v&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array_repr</span><span class="p">(</span><span class="n">m_v</span><span class="p">))</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c_v&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array_repr</span><span class="p">(</span><span class="n">c_v</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">m_expected</span><span class="p">,</span> <span class="n">m_v</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">c_expected</span><span class="p">,</span> <span class="n">c_v</span><span class="p">)</span>

<div class="viewcode-block" id="RNNCellTest.testLSTMSimpleDeterministicWithZoneOutInt64"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testLSTMSimpleDeterministicWithZoneOutInt64">[docs]</a>  <span class="k">def</span> <span class="nf">testLSTMSimpleDeterministicWithZoneOutInt64</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_testLSTMSimpleDeterministicWithZoneOutHelper</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span></div>

<div class="viewcode-block" id="RNNCellTest.testLSTMSimpleDeterministicWithZoneOutInt32"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testLSTMSimpleDeterministicWithZoneOutInt32">[docs]</a>  <span class="k">def</span> <span class="nf">testLSTMSimpleDeterministicWithZoneOutInt32</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_testLSTMSimpleDeterministicWithZoneOutHelper</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span></div>

<div class="viewcode-block" id="RNNCellTest.testLNLSTMCell"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testLNLSTMCell">[docs]</a>  <span class="k">def</span> <span class="nf">testLNLSTMCell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">m_v</span><span class="p">,</span> <span class="n">c_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_testLNLSTMCell</span><span class="p">(</span><span class="n">rnn_cell</span><span class="o">.</span><span class="n">LayerNormalizedLSTMCell</span><span class="p">)</span>
    <span class="n">m_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.03960676</span><span class="p">,</span> <span class="mf">0.26547235</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.00677715</span><span class="p">,</span> <span class="mf">0.09782403</span><span class="p">],</span>
                  <span class="p">[</span><span class="o">-</span><span class="mf">0.00272907</span><span class="p">,</span> <span class="mf">0.31641623</span><span class="p">]]</span>
    <span class="n">c_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.14834785</span><span class="p">,</span> <span class="mf">0.3804915</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.00927538</span><span class="p">,</span> <span class="mf">0.38059634</span><span class="p">],</span>
                  <span class="p">[</span><span class="o">-</span><span class="mf">0.01014781</span><span class="p">,</span> <span class="mf">0.46336061</span><span class="p">]]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">m_expected</span><span class="p">,</span> <span class="n">m_v</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">c_expected</span><span class="p">,</span> <span class="n">c_v</span><span class="p">)</span></div>

<div class="viewcode-block" id="RNNCellTest.testLNLSTMCellSimple"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testLNLSTMCellSimple">[docs]</a>  <span class="k">def</span> <span class="nf">testLNLSTMCellSimple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">m_v</span><span class="p">,</span> <span class="n">c_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_testLNLSTMCell</span><span class="p">(</span><span class="n">rnn_cell</span><span class="o">.</span><span class="n">LayerNormalizedLSTMCellSimple</span><span class="p">)</span>
    <span class="n">m_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.03960676</span><span class="p">,</span> <span class="mf">0.26547235</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.00677715</span><span class="p">,</span> <span class="mf">0.09782403</span><span class="p">],</span>
                  <span class="p">[</span><span class="o">-</span><span class="mf">0.00272907</span><span class="p">,</span> <span class="mf">0.31641623</span><span class="p">]]</span>
    <span class="n">c_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.14834785</span><span class="p">,</span> <span class="mf">0.3804915</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.00927538</span><span class="p">,</span> <span class="mf">0.38059634</span><span class="p">],</span>
                  <span class="p">[</span><span class="o">-</span><span class="mf">0.01014781</span><span class="p">,</span> <span class="mf">0.46336061</span><span class="p">]]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">m_expected</span><span class="p">,</span> <span class="n">m_v</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">c_expected</span><span class="p">,</span> <span class="n">c_v</span><span class="p">)</span></div>

<div class="viewcode-block" id="RNNCellTest.testLNLSTMCellProj"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testLNLSTMCellProj">[docs]</a>  <span class="k">def</span> <span class="nf">testLNLSTMCellProj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">m_v</span><span class="p">,</span> <span class="n">c_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_testLNLSTMCell</span><span class="p">(</span>
        <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LayerNormalizedLSTMCellSimple</span><span class="p">,</span> <span class="n">num_hidden_nodes</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">m_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.39790073</span><span class="p">,</span> <span class="mf">0.28511256</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.41482946</span><span class="p">,</span> <span class="mf">0.28972796</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">0.47132283</span><span class="p">,</span> <span class="mf">0.03284446</span><span class="p">]]</span>
    <span class="n">c_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mf">0.3667627</span><span class="p">,</span> <span class="mf">1.03294277</span><span class="p">,</span> <span class="mf">0.24229962</span><span class="p">,</span> <span class="mf">0.43976486</span><span class="p">],</span>
                  <span class="p">[</span><span class="o">-</span><span class="mf">0.15832338</span><span class="p">,</span> <span class="mf">1.22740746</span><span class="p">,</span> <span class="mf">0.19910297</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.14970526</span><span class="p">],</span>
                  <span class="p">[</span><span class="o">-</span><span class="mf">0.57552528</span><span class="p">,</span> <span class="mf">0.9139322</span><span class="p">,</span> <span class="mf">0.41805002</span><span class="p">,</span> <span class="mf">0.58792269</span><span class="p">]]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">m_expected</span><span class="p">,</span> <span class="n">m_v</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">c_expected</span><span class="p">,</span> <span class="n">c_v</span><span class="p">)</span></div>

  <span class="k">def</span> <span class="nf">_testLNLSTMCell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_cls</span><span class="p">,</span> <span class="n">num_hidden_nodes</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
      <span class="n">params</span> <span class="o">=</span> <span class="n">cell_cls</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
      <span class="n">params</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lstm&#39;</span>
      <span class="n">params</span><span class="o">.</span><span class="n">output_nonlinearity</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="n">params</span><span class="o">.</span><span class="n">params_init</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">WeightInit</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1.24</span><span class="p">,</span> <span class="n">_INIT_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">global_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">per_step_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_input_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_output_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="k">if</span> <span class="n">num_hidden_nodes</span><span class="p">:</span>
        <span class="n">params</span><span class="o">.</span><span class="n">num_hidden_nodes</span> <span class="o">=</span> <span class="n">num_hidden_nodes</span>
      <span class="n">params</span><span class="o">.</span><span class="n">zo_prob</span> <span class="o">=</span> <span class="mf">0.0</span>
      <span class="n">params</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="n">_RANDOM_SEED</span>

      <span class="n">lstm</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">cls</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

      <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">_NUMPY_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">inputs</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">act</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)],</span>
          <span class="n">padding</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
      <span class="n">state0</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">c</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
              <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">lstm</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
          <span class="n">m</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
              <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">lstm</span><span class="o">.</span><span class="n">output_size</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
      <span class="n">state1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">FPropDefaultTheta</span><span class="p">(</span><span class="n">state0</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>

      <span class="c1"># Initialize all the variables, and then run one step.</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

      <span class="n">m_v</span> <span class="o">=</span> <span class="n">state1</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
      <span class="n">c_v</span> <span class="o">=</span> <span class="n">state1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;m_v&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array_repr</span><span class="p">(</span><span class="n">m_v</span><span class="p">))</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c_v&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array_repr</span><span class="p">(</span><span class="n">c_v</span><span class="p">))</span>
      <span class="k">return</span> <span class="n">m_v</span><span class="p">,</span> <span class="n">c_v</span>

<div class="viewcode-block" id="RNNCellTest.testQuantizedLSTMCellPadding"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testQuantizedLSTMCellPadding">[docs]</a>  <span class="k">def</span> <span class="nf">testQuantizedLSTMCellPadding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
      <span class="n">params</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">QuantizedLSTMCell</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
      <span class="n">params</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lstm&#39;</span>
      <span class="n">params</span><span class="o">.</span><span class="n">params_init</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">WeightInit</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1.24</span><span class="p">,</span> <span class="n">_INIT_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">global_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">per_step_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_input_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_output_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">cc_schedule</span><span class="o">.</span><span class="n">start_step</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">params</span><span class="o">.</span><span class="n">cc_schedule</span><span class="o">.</span><span class="n">end_step</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">cc_schedule</span><span class="o">.</span><span class="n">start_cap</span> <span class="o">=</span> <span class="mf">5.0</span>
      <span class="n">params</span><span class="o">.</span><span class="n">cc_schedule</span><span class="o">.</span><span class="n">end_cap</span> <span class="o">=</span> <span class="mf">1.0</span>

      <span class="n">lstm</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">QuantizedLSTMCell</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="n">lstm_vars</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">vars</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;lstm vars = &#39;</span><span class="p">,</span> <span class="n">lstm_vars</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;wm&#39;</span> <span class="ow">in</span> <span class="n">lstm_vars</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;cap&#39;</span> <span class="ow">in</span> <span class="n">lstm_vars</span><span class="o">.</span><span class="n">cc_schedule</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

      <span class="n">wm</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">wm</span>
      <span class="n">cap</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">cc_schedule</span><span class="o">.</span><span class="n">cap</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">wm</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">]))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([]))</span>

      <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">_NUMPY_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">inputs</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">act</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)],</span>
          <span class="n">padding</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
      <span class="n">state0</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">c</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">m</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
      <span class="n">state1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">FPropDefaultTheta</span><span class="p">(</span><span class="n">state0</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>

      <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

      <span class="n">m_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]]</span>
      <span class="n">c_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">m_expected</span><span class="p">,</span> <span class="n">state1</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">c_expected</span><span class="p">,</span> <span class="n">state1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>
      <span class="n">update_op</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">PostTrainingStepUpdate</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">update_op</span><span class="p">)</span></div>

<div class="viewcode-block" id="RNNCellTest.testQuantizedLayerNormalizedLSTMCell"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testQuantizedLayerNormalizedLSTMCell">[docs]</a>  <span class="k">def</span> <span class="nf">testQuantizedLayerNormalizedLSTMCell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LayerNormalizedLSTMCell</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">params</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lstm&#39;</span>
    <span class="n">params</span><span class="o">.</span><span class="n">params_init</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">WeightInit</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1.24</span><span class="p">,</span> <span class="n">_INIT_RANDOM_SEED</span><span class="p">)</span>
    <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">global_vn</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">per_step_vn</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">params</span><span class="o">.</span><span class="n">num_input_nodes</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">params</span><span class="o">.</span><span class="n">num_output_nodes</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">params</span><span class="o">.</span><span class="n">zo_prob</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">params</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="n">_RANDOM_SEED</span>
    <span class="n">params</span><span class="o">.</span><span class="n">cc_schedule</span> <span class="o">=</span> <span class="n">quant_utils</span><span class="o">.</span><span class="n">LinearClippingCapSchedule</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
        <span class="n">start_step</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end_step</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">start_cap</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">end_cap</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="n">lstm</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LayerNormalizedLSTMCell</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">lstm_vars</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">vars</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;lstm vars = &#39;</span><span class="p">,</span> <span class="n">lstm_vars</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;wm&#39;</span> <span class="ow">in</span> <span class="n">lstm_vars</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;cap&#39;</span> <span class="ow">in</span> <span class="n">lstm_vars</span><span class="o">.</span><span class="n">cc_schedule</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="n">wm</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">wm</span>
    <span class="n">cap</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">cc_schedule</span><span class="o">.</span><span class="n">cap</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">wm</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([]))</span>

    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">_NUMPY_RANDOM_SEED</span><span class="p">)</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
        <span class="n">act</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)],</span>
        <span class="n">padding</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="n">state0</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
        <span class="n">c</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="n">m</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
    <span class="n">state1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">FPropDefaultTheta</span><span class="p">(</span><span class="n">state0</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
      <span class="c1"># pylint: disable=bad-whitespace</span>
      <span class="n">m_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.03960676</span><span class="p">,</span> <span class="mf">0.26547235</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.00677715</span><span class="p">,</span> <span class="mf">0.09782403</span><span class="p">],</span>
                    <span class="p">[</span><span class="o">-</span><span class="mf">0.00272907</span><span class="p">,</span> <span class="mf">0.31641623</span><span class="p">]]</span>
      <span class="n">c_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.14834785</span><span class="p">,</span> <span class="mf">0.3804915</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.00927538</span><span class="p">,</span> <span class="mf">0.38059634</span><span class="p">],</span>
                    <span class="p">[</span><span class="o">-</span><span class="mf">0.01014781</span><span class="p">,</span> <span class="mf">0.46336061</span><span class="p">]]</span>
      <span class="c1"># pylint: enable=bad-whitespace</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">m_expected</span><span class="p">,</span> <span class="n">state1</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">c_expected</span><span class="p">,</span> <span class="n">state1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">cap</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>
      <span class="n">update_op</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">PostTrainingStepUpdate</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">update_op</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">cap</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span></div>

<div class="viewcode-block" id="RNNCellTest.testQuantizedLSTMCell"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testQuantizedLSTMCell">[docs]</a>  <span class="k">def</span> <span class="nf">testQuantizedLSTMCell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
      <span class="n">params</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">QuantizedLSTMCell</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
      <span class="n">params</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lstm&#39;</span>
      <span class="n">params</span><span class="o">.</span><span class="n">params_init</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">WeightInit</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1.24</span><span class="p">,</span> <span class="n">_INIT_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">global_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">per_step_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_input_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_output_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">cc_schedule</span><span class="o">.</span><span class="n">start_step</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">params</span><span class="o">.</span><span class="n">cc_schedule</span><span class="o">.</span><span class="n">end_step</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">cc_schedule</span><span class="o">.</span><span class="n">start_cap</span> <span class="o">=</span> <span class="mf">5.0</span>
      <span class="n">params</span><span class="o">.</span><span class="n">cc_schedule</span><span class="o">.</span><span class="n">end_cap</span> <span class="o">=</span> <span class="mf">1.0</span>

      <span class="n">lstm</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">QuantizedLSTMCell</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="n">lstm_vars</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">vars</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;lstm vars = &#39;</span><span class="p">,</span> <span class="n">lstm_vars</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;wm&#39;</span> <span class="ow">in</span> <span class="n">lstm_vars</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;cap&#39;</span> <span class="ow">in</span> <span class="n">lstm_vars</span><span class="o">.</span><span class="n">cc_schedule</span><span class="o">.</span><span class="n">cap</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

      <span class="n">wm</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">wm</span>
      <span class="n">cap</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">cc_schedule</span><span class="o">.</span><span class="n">cap</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">wm</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">]))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([]))</span>

      <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">_NUMPY_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">inputs</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">act</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)],</span>
          <span class="n">padding</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
      <span class="n">state0</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">c</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
          <span class="n">m</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
      <span class="n">state1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">FPropDefaultTheta</span><span class="p">(</span><span class="n">state0</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>

      <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

      <span class="n">m_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.097589</span><span class="p">,</span> <span class="mf">0.579055</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.046737</span><span class="p">,</span> <span class="mf">0.187892</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">0.001656</span><span class="p">,</span> <span class="mf">0.426245</span><span class="p">]]</span>
      <span class="n">c_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.241993</span><span class="p">,</span> <span class="mf">0.820267</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.086863</span><span class="p">,</span> <span class="mf">0.349722</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">0.003176</span><span class="p">,</span> <span class="mf">0.655448</span><span class="p">]]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">m_expected</span><span class="p">,</span> <span class="n">state1</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">c_expected</span><span class="p">,</span> <span class="n">state1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">cap</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>
      <span class="n">update_op</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">PostTrainingStepUpdate</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">update_op</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">cap</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span></div>

<div class="viewcode-block" id="RNNCellTest.testQuantizedLSTMCellSimpleTrainingUnclipped"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testQuantizedLSTMCellSimpleTrainingUnclipped">[docs]</a>  <span class="k">def</span> <span class="nf">testQuantizedLSTMCellSimpleTrainingUnclipped</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">m_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.097589</span><span class="p">,</span> <span class="mf">0.579055</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.046737</span><span class="p">,</span> <span class="mf">0.187892</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">0.001656</span><span class="p">,</span> <span class="mf">0.426245</span><span class="p">]]</span>
    <span class="n">c_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.241993</span><span class="p">,</span> <span class="mf">0.820267</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.086863</span><span class="p">,</span> <span class="mf">0.349722</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">0.003176</span><span class="p">,</span> <span class="mf">0.655448</span><span class="p">]]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_testQuantizedLSTMCellSimpleHelper</span><span class="p">(</span>
        <span class="n">is_inference</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">set_training_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">m_expected</span><span class="o">=</span><span class="n">m_expected</span><span class="p">,</span>
        <span class="n">c_expected</span><span class="o">=</span><span class="n">c_expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="RNNCellTest.testQuantizedLSTMCellSimpleTraining"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testQuantizedLSTMCellSimpleTraining">[docs]</a>  <span class="k">def</span> <span class="nf">testQuantizedLSTMCellSimpleTraining</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">padding</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]]</span>
    <span class="n">m_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.09375</span><span class="p">,</span> <span class="mf">0.5625</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.046875</span><span class="p">,</span> <span class="mf">0.1875</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.809813</span><span class="p">,</span> <span class="mf">0.872176</span><span class="p">]]</span>
    <span class="n">c_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.23288</span><span class="p">,</span> <span class="mf">0.806</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.090057</span><span class="p">,</span> <span class="mf">0.355591</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.747715</span><span class="p">,</span> <span class="mf">0.961307</span><span class="p">]]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_testQuantizedLSTMCellSimpleHelper</span><span class="p">(</span>
        <span class="n">is_inference</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">set_training_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">m_expected</span><span class="o">=</span><span class="n">m_expected</span><span class="p">,</span>
        <span class="n">c_expected</span><span class="o">=</span><span class="n">c_expected</span><span class="p">,</span>
        <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">)</span></div>

<div class="viewcode-block" id="RNNCellTest.testQuantizedLSTMCellSimpleHiddenNodes"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testQuantizedLSTMCellSimpleHiddenNodes">[docs]</a>  <span class="k">def</span> <span class="nf">testQuantizedLSTMCellSimpleHiddenNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">m_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.382812</span><span class="p">,</span> <span class="mf">0.296875</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.164062</span><span class="p">,</span> <span class="mf">0.171875</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">0.3125</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.039062</span><span class="p">]]</span>
    <span class="n">c_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mf">0.160339</span><span class="p">,</span> <span class="mf">0.795929</span><span class="p">,</span> <span class="mf">0.449707</span><span class="p">,</span>
                   <span class="mf">0.347534</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.049194</span><span class="p">,</span> <span class="mf">0.548279</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.060852</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.106354</span><span class="p">],</span>
                  <span class="p">[</span><span class="o">-</span><span class="mf">0.464172</span><span class="p">,</span> <span class="mf">0.345947</span><span class="p">,</span> <span class="mf">0.407349</span><span class="p">,</span> <span class="mf">0.430878</span><span class="p">]]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_testQuantizedLSTMCellSimpleHelper</span><span class="p">(</span>
        <span class="n">is_inference</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">set_training_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">m_expected</span><span class="o">=</span><span class="n">m_expected</span><span class="p">,</span>
        <span class="n">c_expected</span><span class="o">=</span><span class="n">c_expected</span><span class="p">,</span>
        <span class="n">num_hidden_nodes</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></div>

<div class="viewcode-block" id="RNNCellTest.testQuantizedLSTMCellSimpleInference"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testQuantizedLSTMCellSimpleInference">[docs]</a>  <span class="k">def</span> <span class="nf">testQuantizedLSTMCellSimpleInference</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># At inference time, quantization/clipping is forced on, so even though</span>
    <span class="c1"># we don&#39;t set the training step, we should get fully quantized results.</span>
    <span class="n">m_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.09375</span><span class="p">,</span> <span class="mf">0.5625</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.046875</span><span class="p">,</span> <span class="mf">0.1875</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.429688</span><span class="p">]]</span>
    <span class="n">c_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.23288</span><span class="p">,</span> <span class="mf">0.806</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.090057</span><span class="p">,</span> <span class="mf">0.355591</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.003937</span><span class="p">,</span> <span class="mf">0.662567</span><span class="p">]]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_testQuantizedLSTMCellSimpleHelper</span><span class="p">(</span>
        <span class="n">is_inference</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">set_training_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">m_expected</span><span class="o">=</span><span class="n">m_expected</span><span class="p">,</span>
        <span class="n">c_expected</span><span class="o">=</span><span class="n">c_expected</span><span class="p">)</span></div>

  <span class="k">def</span> <span class="nf">_testQuantizedLSTMCellSimpleHelper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                         <span class="n">is_inference</span><span class="p">,</span>
                                         <span class="n">set_training_step</span><span class="p">,</span>
                                         <span class="n">m_expected</span><span class="p">,</span>
                                         <span class="n">c_expected</span><span class="p">,</span>
                                         <span class="n">num_hidden_nodes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">padding</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
      <span class="n">params</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LSTMCellSimple</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
      <span class="n">params</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lstm&#39;</span>
      <span class="n">params</span><span class="o">.</span><span class="n">is_eval</span> <span class="o">=</span> <span class="n">is_inference</span>
      <span class="n">params</span><span class="o">.</span><span class="n">is_inference</span> <span class="o">=</span> <span class="n">is_inference</span>
      <span class="n">params</span><span class="o">.</span><span class="n">params_init</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">WeightInit</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1.24</span><span class="p">,</span> <span class="n">_INIT_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">global_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">vn</span><span class="o">.</span><span class="n">per_step_vn</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_input_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_output_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_hidden_nodes</span> <span class="o">=</span> <span class="n">num_hidden_nodes</span>
      <span class="n">params</span><span class="o">.</span><span class="n">output_nonlinearity</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="n">params</span><span class="o">.</span><span class="n">cell_value_cap</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="n">params</span><span class="o">.</span><span class="n">enable_lstm_bias</span> <span class="o">=</span> <span class="kc">False</span>

      <span class="n">cc_schedule</span> <span class="o">=</span> <span class="n">quant_utils</span><span class="o">.</span><span class="n">FakeQuantizationSchedule</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
          <span class="n">clip_start_step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># Step 0 is unclipped.</span>
          <span class="n">clip_end_step</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
          <span class="n">quant_start_step</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
          <span class="n">start_cap</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
          <span class="n">end_cap</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

      <span class="n">qdomain</span> <span class="o">=</span> <span class="n">quant_utils</span><span class="o">.</span><span class="n">SymetricScheduledClipQDomain</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
          <span class="n">cc_schedule</span><span class="o">=</span><span class="n">cc_schedule</span><span class="p">)</span>
      <span class="n">params</span><span class="o">.</span><span class="n">qdomain</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">qdomain</span>

      <span class="c1"># M state uses the default 8-bit quantziation.</span>
      <span class="n">cc_schedule</span> <span class="o">=</span> <span class="n">cc_schedule</span><span class="o">.</span><span class="n">Copy</span><span class="p">()</span>
      <span class="n">qdomain</span> <span class="o">=</span> <span class="n">quant_utils</span><span class="o">.</span><span class="n">SymetricScheduledClipQDomain</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
          <span class="n">cc_schedule</span><span class="o">=</span><span class="n">cc_schedule</span><span class="p">)</span>
      <span class="n">params</span><span class="o">.</span><span class="n">qdomain</span><span class="o">.</span><span class="n">m_state</span> <span class="o">=</span> <span class="n">qdomain</span>

      <span class="c1"># C state uses 16 bit quantization..</span>
      <span class="n">cc_schedule</span> <span class="o">=</span> <span class="n">cc_schedule</span><span class="o">.</span><span class="n">Copy</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">bits</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
      <span class="n">qdomain</span> <span class="o">=</span> <span class="n">quant_utils</span><span class="o">.</span><span class="n">SymetricScheduledClipQDomain</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
          <span class="n">cc_schedule</span><span class="o">=</span><span class="n">cc_schedule</span><span class="p">)</span>
      <span class="n">params</span><span class="o">.</span><span class="n">qdomain</span><span class="o">.</span><span class="n">c_state</span> <span class="o">=</span> <span class="n">qdomain</span>

      <span class="c1"># Fully connected layer clips slightly differently.</span>
      <span class="n">cc_schedule</span> <span class="o">=</span> <span class="n">cc_schedule</span><span class="o">.</span><span class="n">Copy</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">start_cap</span><span class="o">=</span><span class="mf">64.0</span><span class="p">,</span> <span class="n">end_cap</span><span class="o">=</span><span class="mf">8.0</span><span class="p">)</span>
      <span class="n">qdomain</span> <span class="o">=</span> <span class="n">quant_utils</span><span class="o">.</span><span class="n">SymetricScheduledClipQDomain</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
          <span class="n">cc_schedule</span><span class="o">=</span><span class="n">cc_schedule</span><span class="p">)</span>
      <span class="n">params</span><span class="o">.</span><span class="n">qdomain</span><span class="o">.</span><span class="n">fullyconnected</span> <span class="o">=</span> <span class="n">qdomain</span>

      <span class="n">lstm</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">LSTMCellSimple</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="n">lstm_vars</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">vars</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;lstm vars = &#39;</span><span class="p">,</span> <span class="n">lstm_vars</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;wm&#39;</span> <span class="ow">in</span> <span class="n">lstm_vars</span><span class="o">.</span><span class="n">wm</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">num_hidden_nodes</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;w_proj&#39;</span> <span class="ow">in</span> <span class="n">lstm_vars</span><span class="o">.</span><span class="n">w_proj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="s1">&#39;w_proj&#39;</span> <span class="ow">in</span> <span class="n">lstm_vars</span><span class="p">)</span>

      <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">_NUMPY_RANDOM_SEED</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">padding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">padding</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">padding</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">padding</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
      <span class="n">inputs</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">act</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)],</span>
          <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">)</span>
      <span class="n">state0</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">c</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
              <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">lstm</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
          <span class="n">m</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
              <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">lstm</span><span class="o">.</span><span class="n">output_size</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
      <span class="n">state1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">FPropDefaultTheta</span><span class="p">(</span><span class="n">state0</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>

      <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

      <span class="k">if</span> <span class="n">set_training_step</span><span class="p">:</span>
        <span class="c1"># Get it into the fully clipped/quantized part of the schedule.</span>
        <span class="n">update_op</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">PostTrainingStepUpdate</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">update_op</span><span class="p">)</span>

      <span class="c1"># Outputs.</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">m_expected</span><span class="p">,</span> <span class="n">state1</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">c_expected</span><span class="p">,</span> <span class="n">state1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>

      <span class="c1"># Cell reported zeros.</span>
      <span class="n">cell_zero_state</span> <span class="o">=</span> <span class="n">lstm</span><span class="o">.</span><span class="n">zero_state</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllEqual</span><span class="p">(</span><span class="n">cell_zero_state</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">eval</span><span class="p">(),</span>
                          <span class="n">tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">state0</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllEqual</span><span class="p">(</span><span class="n">cell_zero_state</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">eval</span><span class="p">(),</span>
                          <span class="n">tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">state0</span><span class="o">.</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">eval</span><span class="p">())</span>

<div class="viewcode-block" id="RNNCellTest.testSRUCell"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testSRUCell">[docs]</a>  <span class="k">def</span> <span class="nf">testSRUCell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
      <span class="n">params</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">SRUCell</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
      <span class="n">params</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;sru&#39;</span>
      <span class="n">params</span><span class="o">.</span><span class="n">params_init</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">WeightInit</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1.24</span><span class="p">,</span> <span class="n">_INIT_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_input_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_output_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">zo_prob</span> <span class="o">=</span> <span class="mf">0.0</span>
      <span class="n">params</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="n">_RANDOM_SEED</span>

      <span class="n">sru</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">SRUCell</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

      <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">_NUMPY_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">inputs</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">act</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)],</span>
          <span class="n">padding</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
      <span class="n">state0</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">c</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
          <span class="n">m</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
      <span class="n">state1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sru</span><span class="o">.</span><span class="n">FPropDefaultTheta</span><span class="p">(</span><span class="n">state0</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>

      <span class="c1"># Initialize all the variables, and then run one step.</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

      <span class="n">m_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.58657289</span><span class="p">,</span> <span class="mf">0.70520258</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.32375532</span><span class="p">,</span> <span class="mf">0.29133356</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">0.58900255</span><span class="p">,</span> <span class="mf">0.58398587</span><span class="p">]]</span>
      <span class="n">c_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.45297623</span><span class="p">,</span> <span class="mf">0.88433027</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.42112729</span><span class="p">,</span> <span class="mf">0.47023624</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">0.50483131</span><span class="p">,</span> <span class="mf">0.89583319</span><span class="p">]]</span>
      <span class="n">m_v</span> <span class="o">=</span> <span class="n">state1</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
      <span class="n">c_v</span> <span class="o">=</span> <span class="n">state1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;m_v&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array_repr</span><span class="p">(</span><span class="n">m_v</span><span class="p">))</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c_v&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array_repr</span><span class="p">(</span><span class="n">c_v</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">m_expected</span><span class="p">,</span> <span class="n">m_v</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">c_expected</span><span class="p">,</span> <span class="n">c_v</span><span class="p">)</span></div>

<div class="viewcode-block" id="RNNCellTest.testQRNNPoolingCell"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testQRNNPoolingCell">[docs]</a>  <span class="k">def</span> <span class="nf">testQRNNPoolingCell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">num_rnn_matrices</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
      <span class="n">params</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">QRNNPoolingCell</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
      <span class="n">params</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;QuasiRNN&#39;</span>
      <span class="n">params</span><span class="o">.</span><span class="n">params_init</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">WeightInit</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1.24</span><span class="p">,</span> <span class="n">_INIT_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_input_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_output_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">zo_prob</span> <span class="o">=</span> <span class="mf">0.0</span>
      <span class="n">params</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="n">_RANDOM_SEED</span>
      <span class="n">params</span><span class="o">.</span><span class="n">pooling_formula</span> <span class="o">=</span> <span class="s1">&#39;quasi_ifo&#39;</span>

      <span class="n">qrnn</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">QRNNPoolingCell</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

      <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">_NUMPY_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">inputs</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">act</span><span class="o">=</span><span class="p">[</span>
              <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
                      <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">num_input_nodes</span> <span class="o">*</span> <span class="n">num_rnn_matrices</span><span class="p">)),</span>
                  <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
          <span class="p">],</span>
          <span class="n">padding</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
      <span class="n">state0</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">c</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
              <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">num_output_nodes</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
          <span class="n">m</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
              <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">num_output_nodes</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
      <span class="n">state1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">qrnn</span><span class="o">.</span><span class="n">FPropDefaultTheta</span><span class="p">(</span><span class="n">state0</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>

      <span class="c1"># Initialize all the variables, and then run one step.</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

      <span class="n">m_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.40564698</span><span class="p">,</span> <span class="mf">0.32611847</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.16975531</span><span class="p">,</span> <span class="mf">0.45970476</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">0.60286027</span><span class="p">,</span> <span class="mf">0.24542703</span><span class="p">]]</span>
      <span class="n">c_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.42057115</span><span class="p">,</span> <span class="mf">0.49928033</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.56830668</span><span class="p">,</span> <span class="mf">0.7003305</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">1.28926766</span><span class="p">,</span> <span class="mf">0.75380397</span><span class="p">]]</span>
      <span class="n">m_v</span> <span class="o">=</span> <span class="n">state1</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
      <span class="n">c_v</span> <span class="o">=</span> <span class="n">state1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;m_v&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array_repr</span><span class="p">(</span><span class="n">m_v</span><span class="p">))</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c_v&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array_repr</span><span class="p">(</span><span class="n">c_v</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">m_expected</span><span class="p">,</span> <span class="n">m_v</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">c_expected</span><span class="p">,</span> <span class="n">c_v</span><span class="p">)</span></div>

<div class="viewcode-block" id="RNNCellTest.testQRNNPoolingCellInSRUMode"><a class="viewcode-back" href="../../../lingvo.core.rnn_cell_test.html#lingvo.core.rnn_cell_test.RNNCellTest.testQRNNPoolingCellInSRUMode">[docs]</a>  <span class="k">def</span> <span class="nf">testQRNNPoolingCellInSRUMode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">num_rnn_matrices</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
      <span class="n">params</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">QRNNPoolingCell</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
      <span class="n">params</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;SRU&#39;</span>
      <span class="n">params</span><span class="o">.</span><span class="n">params_init</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">WeightInit</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">1.24</span><span class="p">,</span> <span class="n">_INIT_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_input_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">num_output_nodes</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">params</span><span class="o">.</span><span class="n">zo_prob</span> <span class="o">=</span> <span class="mf">0.0</span>
      <span class="n">params</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="n">_RANDOM_SEED</span>
      <span class="n">params</span><span class="o">.</span><span class="n">pooling_formula</span> <span class="o">=</span> <span class="s1">&#39;sru&#39;</span>

      <span class="n">sru</span> <span class="o">=</span> <span class="n">rnn_cell</span><span class="o">.</span><span class="n">QRNNPoolingCell</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

      <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">_NUMPY_RANDOM_SEED</span><span class="p">)</span>
      <span class="n">inputs</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">act</span><span class="o">=</span><span class="p">[</span>
              <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
                      <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">num_input_nodes</span> <span class="o">*</span> <span class="n">num_rnn_matrices</span><span class="p">)),</span>
                  <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
          <span class="p">],</span>
          <span class="n">padding</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
      <span class="n">state0</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
          <span class="n">c</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
              <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">num_output_nodes</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
          <span class="n">m</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
              <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">num_output_nodes</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
      <span class="n">state1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sru</span><span class="o">.</span><span class="n">FPropDefaultTheta</span><span class="p">(</span><span class="n">state0</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>

      <span class="c1"># Initialize all the variables, and then run one step.</span>
      <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

      <span class="n">m_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.55884922</span><span class="p">,</span> <span class="mf">0.40396619</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.71426249</span><span class="p">,</span> <span class="mf">0.70820922</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">0.823457</span><span class="p">,</span> <span class="mf">0.60304904</span><span class="p">]]</span>
      <span class="n">c_expected</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.65144706</span><span class="p">,</span> <span class="mf">0.56252223</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.75096267</span><span class="p">,</span> <span class="mf">0.65605044</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">0.79761195</span><span class="p">,</span> <span class="mf">0.36905324</span><span class="p">]]</span>
      <span class="n">m_v</span> <span class="o">=</span> <span class="n">state1</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
      <span class="n">c_v</span> <span class="o">=</span> <span class="n">state1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;m_v&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array_repr</span><span class="p">(</span><span class="n">m_v</span><span class="p">))</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c_v&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array_repr</span><span class="p">(</span><span class="n">c_v</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">m_expected</span><span class="p">,</span> <span class="n">m_v</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">assertAllClose</span><span class="p">(</span><span class="n">c_expected</span><span class="p">,</span> <span class="n">c_v</span><span class="p">)</span></div></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="n">tf</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'',
            LANGUAGE:'en',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>